name: charmarr-multimeter-k8s
type: charm
title: Charmarr Multimeter
summary: Test utility charm for validating Charmarr interface implementations
description: |
  A minimal test utility charm that implements the requirer side of all Charmarr
  interfaces. Used for integration testing of provider charms.

  This charm:
  - Implements all Charmarr interfaces as requirer only
  - Publishes minimal data to complete relation handshakes
  - Receives provider data for test assertions
  - Provides actions for K8s resource inspection (get-pvc, get-pv, get-mounts)
  - Has no config options - uses sensible defaults

  Tests use juju show-unit or jhack to inspect received relation data.

links:
  documentation: https://github.com/charmarr/charmarr
  source: https://github.com/charmarr/charmarr
  issues: https://github.com/charmarr/charmarr/issues

assumes:
  - k8s-api
  - juju >= 3.6

base: ubuntu@24.04
platforms:
  amd64:

containers:
  multimeter:
    resource: multimeter-image

resources:
  multimeter-image:
    type: oci-image
    description: Container image for multimeter
    upstream-source: docker.io/library/busybox:latest

parts:
  charm:
    source: .
    plugin: uv
    build-packages: [git]
    build-snaps: [astral-uv]
# FIXME: git describe doesn't work - charmcraft copies source without .git directory
#    override-build: |
#      craftctl default
#      git describe --always > $CRAFT_PART_INSTALL/version

charm-libs:
  - lib: istio_beacon_k8s.service_mesh
    version: "0"

requires:
  media-storage:
    interface: media-storage
    optional: true
  media-indexer:
    interface: media-indexer
    optional: true
  download-client:
    interface: download-client
    optional: true
  media-manager:
    interface: media-manager
    optional: true
  vpn-gateway:
    interface: vpn-gateway
    optional: true
  service-mesh:
    interface: service_mesh
    limit: 1
    optional: true
    description: Subscribe this charm into a service mesh for policy-driven traffic management
  require-cmr-mesh:
    interface: cross_model_mesh
    optional: true
    description: Allow cross-model applications access via service mesh

provides:
  provide-cmr-mesh:
    interface: cross_model_mesh
    optional: true
    description: Access cross-model applications via service mesh

actions:
  get-pvc:
    description: Get PVC details from Kubernetes
    params:
      namespace:
        type: string
        description: Kubernetes namespace
      name:
        type: string
        description: PVC name
    required: [namespace, name]
  get-pv:
    description: Get PV details from Kubernetes
    params:
      name:
        type: string
        description: PV name
    required: [name]
  deploy-nfs-server:
    description: Deploy a mock NFS server for testing native-nfs backend
    params:
      timeout:
        type: integer
        description: Timeout in seconds to wait for server to be ready (default 120)
        default: 120
  cleanup-nfs-server:
    description: Remove the mock NFS server
  get-mounts:
    description: Get list of mount paths in the workload container
  get-external-ip:
    description: Get external IP from within the container (via ifconfig.me)
  check-vxlan-interface:
    description: Check if vxlan interface exists and get its IP
  check-connectivity:
    description: Check if container can reach a target
    params:
      target:
        type: string
        description: Target host/IP to check connectivity
      timeout:
        type: integer
        description: Timeout in seconds (default 5)
        default: 5
    required: [target]
  get-statefulset-containers:
    description: Get container names from a StatefulSet
    params:
      namespace:
        type: string
        description: Kubernetes namespace
      name:
        type: string
        description: StatefulSet name
    required: [namespace, name]
  get-container-env:
    description: Get environment variables from a container in a StatefulSet
    params:
      namespace:
        type: string
        description: Kubernetes namespace
      name:
        type: string
        description: StatefulSet name
      container:
        type: string
        description: Container name
      var:
        type: string
        description: Optional specific variable name to retrieve
    required: [namespace, name, container]
  check-network-policy:
    description: Check if a NetworkPolicy exists and get its egress CIDRs
    params:
      namespace:
        type: string
        description: Kubernetes namespace
      name:
        type: string
        description: NetworkPolicy name
    required: [namespace, name]
  check-configmap:
    description: Check if a ConfigMap exists
    params:
      namespace:
        type: string
        description: Kubernetes namespace
      name:
        type: string
        description: ConfigMap name
    required: [namespace, name]
  get-gateway-client-config:
    description: Get parsed gateway client config (vxlan-id, k8s-dns-ips, etc.)
