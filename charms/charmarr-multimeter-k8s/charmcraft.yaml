name: charmarr-multimeter-k8s
type: charm
title: Charmarr Multimeter
summary: Test utility charm for validating Charmarr interface implementations
description: |
  A minimal test utility charm that implements the requirer side of all Charmarr
  interfaces. Used for integration testing of provider charms.

  This charm:
  - Implements all Charmarr interfaces as requirer only
  - Publishes minimal data to complete relation handshakes
  - Receives provider data for test assertions
  - Has no config options - uses sensible defaults

  Tests use juju show-unit or jhack to inspect received relation data.

links:
  documentation: https://github.com/charmarr/charmarr
  source: https://github.com/charmarr/charmarr
  issues: https://github.com/charmarr/charmarr/issues

assumes:
  - k8s-api
  - juju >= 3.6

base: ubuntu@24.04
platforms:
  amd64:

containers:
  multimeter:
    resource: multimeter-image

resources:
  multimeter-image:
    type: oci-image
    description: Container image for multimeter
    upstream-source: busybox:latest

parts:
  charm:
    source: .
    plugin: uv
    build-packages: [git]
    build-snaps: [astral-uv]
# FIXME: git describe doesn't work - charmcraft copies source without .git directory
#    override-build: |
#      craftctl default
#      git describe --always > $CRAFT_PART_INSTALL/version

requires:
  media-storage:
    interface: media-storage
    optional: true
  media-indexer:
    interface: media-indexer
    optional: true
  download-client:
    interface: download-client
    optional: true
  media-manager:
    interface: media-manager
    optional: true
  vpn-gateway:
    interface: vpn-gateway
    optional: true

actions:
  get-pvc:
    description: Get PVC details from Kubernetes
    params:
      namespace:
        type: string
        description: Kubernetes namespace
      name:
        type: string
        description: PVC name
    required: [namespace, name]
  get-pv:
    description: Get PV details from Kubernetes
    params:
      name:
        type: string
        description: PV name
    required: [name]
  deploy-nfs-server:
    description: Deploy a mock NFS server for testing native-nfs backend
    params:
      timeout:
        type: integer
        description: Timeout in seconds to wait for server to be ready (default 120)
        default: 120
  cleanup-nfs-server:
    description: Remove the mock NFS server
  get-mounts:
    description: Get list of mount paths in the workload container
