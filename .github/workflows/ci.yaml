name: CI

on:
  pull_request:

jobs:
  detect:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      multimeter: ${{ steps.check.outputs.multimeter }}
      storage: ${{ steps.check.outputs.storage }}
      gluetun: ${{ steps.check.outputs.gluetun }}
      qbittorrent: ${{ steps.check.outputs.qbittorrent }}
      sabnzbd: ${{ steps.check.outputs.sabnzbd }}
      flaresolverr: ${{ steps.check.outputs.flaresolverr }}
      prowlarr: ${{ steps.check.outputs.prowlarr }}
      radarr: ${{ steps.check.outputs.radarr }}
      sonarr: ${{ steps.check.outputs.sonarr }}
      plex: ${{ steps.check.outputs.plex }}
      overseerr: ${{ steps.check.outputs.overseerr }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: check
        run: |
          base="${{ github.event.pull_request.base.sha }}"
          changed=$(git diff --name-only "$base"...HEAD)

          if echo "$changed" | grep -q "^charms/charmarr-multimeter-k8s/"; then
            echo "multimeter=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/charmarr-storage-k8s/"; then
            echo "storage=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/gluetun-k8s/"; then
            echo "gluetun=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/qbittorrent-k8s/"; then
            echo "qbittorrent=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/sabnzbd-k8s/"; then
            echo "sabnzbd=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/flaresolverr-k8s/"; then
            echo "flaresolverr=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/prowlarr-k8s/"; then
            echo "prowlarr=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/radarr-k8s/"; then
            echo "radarr=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/sonarr-k8s/"; then
            echo "sonarr=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/plex-k8s/"; then
            echo "plex=true" >> "$GITHUB_OUTPUT"
          fi

          if echo "$changed" | grep -q "^charms/overseerr-k8s/"; then
            echo "overseerr=true" >> "$GITHUB_OUTPUT"
          fi

  multimeter:
    name: Multimeter
    needs: detect
    if: needs.detect.outputs.multimeter == 'true'
    uses: ./.github/workflows/multimeter-k8s-ci.yaml

  storage:
    name: Storage
    needs: detect
    if: needs.detect.outputs.storage == 'true'
    uses: ./.github/workflows/storage-k8s-ci.yaml

  gluetun:
    name: Gluetun
    needs: detect
    if: needs.detect.outputs.gluetun == 'true'
    uses: ./.github/workflows/gluetun-k8s-ci.yaml

  qbittorrent:
    name: qBittorrent
    needs: detect
    if: needs.detect.outputs.qbittorrent == 'true'
    uses: ./.github/workflows/qbittorrent-k8s-ci.yaml

  sabnzbd:
    name: SABnzbd
    needs: detect
    if: needs.detect.outputs.sabnzbd == 'true'
    uses: ./.github/workflows/sabnzbd-k8s-ci.yaml

  flaresolverr:
    name: FlareSolverr
    needs: detect
    if: needs.detect.outputs.flaresolverr == 'true'
    uses: ./.github/workflows/flaresolverr-k8s-ci.yaml

  prowlarr:
    name: Prowlarr
    needs: detect
    if: needs.detect.outputs.prowlarr == 'true'
    uses: ./.github/workflows/prowlarr-k8s-ci.yaml

  radarr:
    name: Radarr
    needs: detect
    if: needs.detect.outputs.radarr == 'true'
    uses: ./.github/workflows/radarr-k8s-ci.yaml

  sonarr:
    name: Sonarr
    needs: detect
    if: needs.detect.outputs.sonarr == 'true'
    uses: ./.github/workflows/sonarr-k8s-ci.yaml

  plex:
    name: Plex
    needs: detect
    if: needs.detect.outputs.plex == 'true'
    uses: ./.github/workflows/plex-k8s-ci.yaml

  overseerr:
    name: Overseerr
    needs: detect
    if: needs.detect.outputs.overseerr == 'true'
    uses: ./.github/workflows/overseerr-k8s-ci.yaml
