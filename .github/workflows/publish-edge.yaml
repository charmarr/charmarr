name: Publish Edge

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      charm:
        description: Charm to publish (auto = detect from changes)
        type: choice
        options:
          - auto
          - multimeter
          - storage
          - gluetun
          - qbittorrent
          - sabnzbd
          - flaresolverr
          - prowlarr
          - radarr
          - sonarr
          - all
        default: auto
      dry-run:
        description: Skip actual publish (for testing)
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  detect:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      multimeter: ${{ steps.check.outputs.multimeter }}
      storage: ${{ steps.check.outputs.storage }}
      gluetun: ${{ steps.check.outputs.gluetun }}
      qbittorrent: ${{ steps.check.outputs.qbittorrent }}
      sabnzbd: ${{ steps.check.outputs.sabnzbd }}
      flaresolverr: ${{ steps.check.outputs.flaresolverr }}
      prowlarr: ${{ steps.check.outputs.prowlarr }}
      radarr: ${{ steps.check.outputs.radarr }}
      sonarr: ${{ steps.check.outputs.sonarr }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: check
        env:
          CHARM_INPUT: ${{ inputs.charm }}
        run: |
          # Manual selection
          if [[ "$CHARM_INPUT" == "multimeter" || "$CHARM_INPUT" == "all" ]]; then
            echo "multimeter=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "storage" || "$CHARM_INPUT" == "all" ]]; then
            echo "storage=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "gluetun" || "$CHARM_INPUT" == "all" ]]; then
            echo "gluetun=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "qbittorrent" || "$CHARM_INPUT" == "all" ]]; then
            echo "qbittorrent=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "sabnzbd" || "$CHARM_INPUT" == "all" ]]; then
            echo "sabnzbd=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "flaresolverr" || "$CHARM_INPUT" == "all" ]]; then
            echo "flaresolverr=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "prowlarr" || "$CHARM_INPUT" == "all" ]]; then
            echo "prowlarr=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "radarr" || "$CHARM_INPUT" == "all" ]]; then
            echo "radarr=true" >> "$GITHUB_OUTPUT"
          fi
          if [[ "$CHARM_INPUT" == "sonarr" || "$CHARM_INPUT" == "all" ]]; then
            echo "sonarr=true" >> "$GITHUB_OUTPUT"
          fi

          # Auto-detect from changes (push or workflow_dispatch with auto)
          if [[ -z "$CHARM_INPUT" || "$CHARM_INPUT" == "auto" ]]; then
            changed=$(git diff --name-only HEAD~1 HEAD)

            if echo "$changed" | grep -q "^charms/charmarr-multimeter-k8s/"; then
              echo "multimeter=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/charmarr-storage-k8s/"; then
              echo "storage=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/gluetun-k8s/"; then
              echo "gluetun=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/qbittorrent-k8s/"; then
              echo "qbittorrent=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/sabnzbd-k8s/"; then
              echo "sabnzbd=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/flaresolverr-k8s/"; then
              echo "flaresolverr=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/prowlarr-k8s/"; then
              echo "prowlarr=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/radarr-k8s/"; then
              echo "radarr=true" >> "$GITHUB_OUTPUT"
            fi
            if echo "$changed" | grep -q "^charms/sonarr-k8s/"; then
              echo "sonarr=true" >> "$GITHUB_OUTPUT"
            fi
          fi

  multimeter:
    name: Multimeter
    needs: detect
    if: needs.detect.outputs.multimeter == 'true'
    uses: ./.github/workflows/multimeter-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  storage:
    name: Storage
    needs: detect
    if: needs.detect.outputs.storage == 'true'
    uses: ./.github/workflows/storage-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  gluetun:
    name: Gluetun
    needs: detect
    if: needs.detect.outputs.gluetun == 'true'
    uses: ./.github/workflows/gluetun-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  qbittorrent:
    name: qBittorrent
    needs: detect
    if: needs.detect.outputs.qbittorrent == 'true'
    uses: ./.github/workflows/qbittorrent-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  sabnzbd:
    name: SABnzbd
    needs: detect
    if: needs.detect.outputs.sabnzbd == 'true'
    uses: ./.github/workflows/sabnzbd-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  flaresolverr:
    name: FlareSolverr
    needs: detect
    if: needs.detect.outputs.flaresolverr == 'true'
    uses: ./.github/workflows/flaresolverr-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  prowlarr:
    name: Prowlarr
    needs: detect
    if: needs.detect.outputs.prowlarr == 'true'
    uses: ./.github/workflows/prowlarr-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  radarr:
    name: Radarr
    needs: detect
    if: needs.detect.outputs.radarr == 'true'
    uses: ./.github/workflows/radarr-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit

  sonarr:
    name: Sonarr
    needs: detect
    if: needs.detect.outputs.sonarr == 'true'
    uses: ./.github/workflows/sonarr-k8s-publish-edge.yaml
    with:
      dry-run: ${{ inputs.dry-run || false }}
    secrets: inherit
